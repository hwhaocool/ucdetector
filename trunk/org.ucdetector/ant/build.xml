<?xml version="1.0" encoding="UTF-8"?>
<!-- ====================================================================
  Copyright (c) 2010 Joerg Spieler All rights reserved. This program and the
  accompanying materials are made available under the terms of the Eclipse
  Public License v1.0 which accompanies this distribution, and is available at
  http://www.eclipse.org/legal/epl-v10.html
  ========================================================================= -->
<project name="Run UCDetector" default="detect" basedir=".">
  <description>Run UCDetector in headless mode</description>

  <property name="WORKSPACE" location="../workspace" />
  <property name="ECLIPSE_HOME" location="../eclipse" />
  <!-- Default report directory. But depends on options.properties -->
  <property name="reports.dir" location="${WORKSPACE}/ucdetector_reports" />

  <!-- =====================================================================
       OPTIONS
       =====================================================================
buildType:
    One of: AUTO_BUILD (default), FULL_BUILD (clean all and build all), CLEAN_BUILD, INCREMENTAL_BUILD 
    For details see: org.eclipse.core.resources.IncrementalProjectBuilder
    Example: buildType="AUTO_BUILD"
optionsFile:
    - Edit options.properties file
    - Or set UCDetector preferences in eclipse IDE
      and use mode file from: WORKSPACE_IDE/.metadata/.plugins/org.ucdetector/modes/
      Example: optionsFile="options.properties"
targetPlatformFile:
    Only needed, if you use a target platform different to ECLIPSE_HOME
    CHANGE file ucdetector.target, when using target platform!
    Examples:
      targetPlatformFile="ucdetector.target", targetPlatformFile="${WORKSPACE}/myProject/myTarget.target"
report:
    eachproject (default), single
    Example: report="eachproject"
-->

  <!-- =====================================================================
       RUN UCDETECTOR
       ===================================================================== -->
  <!-- Change code for custom target platform, report, project to detect...  -->
  <target name="run-ucdetector" description="Run UCDetector">
    <ucdetector buildType="FULL_BUILD"
                optionsFile="options.properties"
                targetPlatformFile="ucdetector.target"
                report="eachproject">
      <!-- Resources to build: Leave empty, to build ALL projects
      <iterate name="myProject" />
      <iterate name="myOtherProject/src/main" />
      -->
    </ucdetector>
  </target>

  <!-- =====================================================================
       DETECT
       ===================================================================== -->
  <!-- Usually there is no need to change code here!                         -->
  <target name="detect" description="Run UCDetector using java">
    <property name="ucd.target" value="run-ucdetector" />
    <echo>
# -----------------------------------------------------------------------------
# ECLIPSE_HOME = ${ECLIPSE_HOME}
# WORKSPACE    = ${WORKSPACE}
# reports.dir  = ${reports.dir}
# ucd.target   = ${ucd.target}
# debug        = ${debug}
# -----------------------------------------------------------------------------
</echo>
    <available file="${ECLIPSE_HOME}" property="ECLIPSE_HOME.exists" />
    <fail unless="ECLIPSE_HOME.exists" message="Missing ${ECLIPSE_HOME}. Edit property ECLIPSE_HOME" />
    <available file="${WORKSPACE}" property="WORKSPACE.exists" />
    <fail unless="WORKSPACE.exists" message="Missing ${WORKSPACE}. Edit property WORKSPACE" />

    <!-- LAUNCHER -->
    <pathconvert property="LAUNCHER">
      <fileset dir="${ECLIPSE_HOME}/plugins" includes="org.eclipse.equinox.launcher_*.jar" />
    </pathconvert>
    <echo>LAUNCHER = '${LAUNCHER}'
when LAUNCHER is empty, create new property 'LAUNCHER'</echo>

    <java jar="${LAUNCHER}" fork="true" maxmemory="1024m">
      <!-- <arg line="-debug" /> -->
      <arg line="-clean" />
      <arg line="-data ${WORKSPACE}" />
      <arg line="-application org.eclipse.ant.core.antRunner" />
      <!-- The name of this file -->
      <arg line="-buildfile build.xml" />
      <!-- The target in this this file -->
      <arg line="${ucd.target}" />
    </java>
  </target>

  <!-- =====================================================================
       EXAMPLE: Call UCDetector's build.xml from your main build.xml
       ===================================================================== -->
  <target name="call-ucdetector" description="Call UCDetector from another ant file">
    <property name="ucd.ant.dir" location="my_local_ucdetector_ant_dir" />
    <ant antfile="${ucd.ant.dir}/build.xml" target="detect" inheritall="false">
      <!-- Usually there is no need to change target -->
      <property name="ucd.target" value="run-ucdetector" />
    </ant>
  </target>
</project>